[gcode_macro RatOS]
variable_z_probe: "static"

[beacon]
serial: /dev/serial/by-id/usb-Beacon_Beacon_RevH_03B9BBF24E5737374D202020FF0F111F-if00
x_offset: 0 # update with offset from nozzle on your machine
y_offset: 20.70 # update with offset from nozzle on your machine
mesh_main_direction: x
mesh_runs: 2
speed: 15.
lift_speed: 80.
home_method: contact
home_method_when_homed: proximity
home_autocalibrate: unhomed
home_xy_position: 275, 260
home_z_hop: 0
home_z_hop_speed: 30
home_xy_move_speed: 350
contact_max_hotend_temperature: 280

[stepper_z]
homing_retract_dist: 0

[bed_mesh]
speed: 900
mesh_min: 5, 35
mesh_max: 290, 260
probe_count: 25,25
    
[z_tilt]
speed: 300
retries: 5

points:
  	27, 0
  	146,255
	265, 0


[resonance_tester]
accel_chip: beacon
probe_points: 150, 150, 20

[gcode_macro RatOS]
variable_beacon_bed_mesh_scv: 25                        # square corner velocity for bed meshing with proximity method
variable_beacon_contact_z_homing: False                 # printer z-homing with contact method
variable_beacon_contact_z_calibration: False            # contact z-calibration before the print starts
                                                        # after changing this variable please run a recalibration before you use the printer  
												        # if you use a smooth PEI sheet turn this feature off

variable_beacon_contact_calibration_location: "center"  # center = center of the build plate
                                                        # front = front center
														# corner = front corner

variable_beacon_contact_calibrate_margin_x: 30          # x-margin if calibrate in front corners
variable_beacon_contact_bed_mesh: False                 # bed mesh with contact method
variable_beacon_contact_bed_mesh_samples: 2             # probe samples for contact bed mesh
variable_beacon_contact_z_tilt_adjust: False            # z-tilt adjust with contact method
variable_beacon_contact_z_tilt_adjust_samples: 2        # probe samples for contact z-tilt adjust
variable_beacon_contact_prime_probing: False            # probe for priming with contact method
variable_beacon_contact_calibration_temp: 150           # nozzle temperature for auto calibration
variable_beacon_contact_expansion_compensation: False   # enables the nozzle thermal expansion compensation
variable_beacon_contact_expansion_multiplier: 1.0       # multiplier for the nozzle thermal expansion compensation
#####
# BEACON COMMON
#####
[delayed_gcode _BEACON_INIT]
initial_duration: 0.1
gcode:
	# reset nozzle thermal expansion offset
	_BEACON_SET_NOZZLE_TEMP_OFFSET RESET=True
	
	
#####
# BEACON NOZZLE TEMPERATURE OFFSET COMPENSATION
#####
[gcode_macro _BEACON_SET_NOZZLE_TEMP_OFFSET]
gcode:
	# parameters
	{% set toolhead = params.TOOLHEAD|default(0)|int %}
	{% set reset = true if params.RESET|default(false)|lower == 'true' else false %}

	# config 
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}

	# beacon config
	{% set beacon_contact_calibration_temp = printer["gcode_macro RatOS"].beacon_contact_calibration_temp|default(150)|int %}
	{% set beacon_contact_expansion_multiplier = printer["gcode_macro RatOS"].beacon_contact_expansion_multiplier|default(1.0)|float %}
	{% set beacon_contact_z_calibration = true if printer["gcode_macro RatOS"].beacon_contact_z_calibration|default(false)|lower == 'true' else false %}
	{% set beacon_contact_expansion_compensation = true if printer["gcode_macro RatOS"].beacon_contact_expansion_compensation|default(false)|lower == 'true' else false %}

	# ratos variables file
	{% set svv = printer.save_variables.variables %}

	{% if reset %}
		# reset applied offset
		SAVE_VARIABLE VARIABLE=nozzle_expansion_applied_offset VALUE=0

	{% else %}
		{% if beacon_contact_z_calibration and beacon_contact_expansion_compensation %}

			# get coefficient value
			{% set nozzle_expansion_coefficient_t0 = svv.nozzle_expansion_coefficient_t0|default(0)|float %}
			{% if printer["dual_carriage"] is defined %}
				{% set nozzle_expansion_coefficient_t1 = svv.nozzle_expansion_coefficient_t1|default(0)|float %}
			{% endif %}

			# get applied offset
			{% set applied_offset = svv.nozzle_expansion_applied_offset|default(0)|float %}

			# get extruder target temperature
			{% set temp = printer['extruder' if toolhead == 0 else 'extruder1'].target|float %}

			# calculate new offset
			{% set temp_offset = temp - beacon_contact_calibration_temp %}
			{% set expansion_coefficient = nozzle_expansion_coefficient_t0 if toolhead == 0 else nozzle_expansion_coefficient_t1 %}
			{% set expansion_offset = beacon_contact_expansion_multiplier * (temp_offset * (expansion_coefficient / 100)) %}

			# set new offset
			{% set new_offset = ((-applied_offset) + expansion_offset) %}
			SET_GCODE_OFFSET Z_ADJUST={new_offset} MOVE=1 SPEED={z_speed}
			SAVE_VARIABLE VARIABLE=nozzle_expansion_applied_offset VALUE={expansion_offset}

			# echo
			RATOS_ECHO PREFIX="BEACON" MSG={'"Nozzle expansion offset of %.6fmm applied to T%s"' % (expansion_offset, toolhead)}

		{% endif %}
	{% endif %}


[gcode_macro _BEACON_REMOVE_NOZZLE_TEMP_OFFSET]
gcode:
	# config 
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}

	# beacon config
	{% set beacon_contact_z_calibration = true if printer["gcode_macro RatOS"].beacon_contact_z_calibration|default(false)|lower == 'true' else false %}
	{% set beacon_contact_expansion_compensation = true if printer["gcode_macro RatOS"].beacon_contact_expansion_compensation|default(false)|lower == 'true' else false %}

	{% if beacon_contact_z_calibration and beacon_contact_expansion_compensation %}

		# ratos variables file
		{% set svv = printer.save_variables.variables %}

		# get applied offset
		{% set applied_offset = svv.nozzle_expansion_applied_offset|default(0)|float %}

		# remove applied offset
		{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
		SET_GCODE_OFFSET Z_ADJUST={(-applied_offset)} MOVE=0 SPEED={z_speed}

	{% endif %}


#####
# BEACON NOZZLE TEMPERATURE OFFSET CALIBRATION
#####
[gcode_macro BEACON_CALIBRATE_NOZZLE_TEMP_OFFSET]
variable_reference_z: 0.0
gcode:
	# config
	{% set test_margin = 30 %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
	{% set printable_y_max = printer["gcode_macro RatOS"].printable_y_max|float %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
		{% set safe_home_x = printable_x_max / 2 %}
	{% endif %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
		{% set safe_home_y = printable_y_max / 2 %}
	{% endif %}
	{% set default_toolhead = printer["gcode_macro RatOS"].default_toolhead|default(0)|int %}

	# home printer if needed
	MAYBE_HOME

	# automatic bed leveling
	{% set needs_rehoming = False %}
	{% if printer.z_tilt is defined and not printer.z_tilt.applied %}
		RATOS_ECHO MSG="Adjusting Z tilt..."
		Z_TILT_ADJUST
		RATOS_ECHO MSG="Rehoming Z after Z tilt adjustment..."
		{% set needs_rehoming = True %}
	{% endif %}
	{% if printer.quad_gantry_level is defined and not printer.quad_gantry_level.applied %}
	 	RATOS_ECHO MSG="Running quad gantry leveling..."
		QUAD_GANTRY_LEVEL 
		RATOS_ECHO MSG="Rehoming Z after quad gantry leveling..."
		{% set needs_rehoming = True %}
	{% endif %}

	# Home again as Z will have changed after automatic bed leveling and bed heating.
	{% if needs_rehoming %}
		G0 Z{z_hop} F{z_hop_speed}
		G0 X{safe_home_x} Y{safe_home_y} F{speed}
		{% if printer.configfile.settings.beacon is defined and beacon_contact_z_homing %}
			BEACON_AUTO_CALIBRATE  
			G0 Z{z_hop} F{z_hop_speed}
			G0 X{safe_home_x} Y{safe_home_y} F{speed}
		{% else %}
			G28 Z
		{% endif %}
	{% endif %}

	# beacon autocalibration
	G0 Z{z_hop} F{z_speed}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	G0 Z5 F{z_speed}
	BEACON_AUTO_CALIBRATE

	RATOS_ECHO PREFIX="BEACON" MSG="Nozzle temperature offset calibration..."

	# settle the mechanics down  
	{% for i in range(10) %}
		beacon_poke speed=3 top=5 bottom=-0.6
	{% endfor %}

	# get and set start temperature offset 
	_BEACON_PROBE_NOZZLE_TEMP_OFFSET TEMP=150
	_BEACON_STORE_NOZZLE_TEMP_OFFSET TEMP=150

	# get and set end temperature offset
	_BEACON_PROBE_NOZZLE_TEMP_OFFSET TEMP=250
	_BEACON_STORE_NOZZLE_TEMP_OFFSET TEMP=250

	# get and set start temperature offset 
	_BEACON_PROBE_NOZZLE_TEMP_OFFSET TEMP=150
	_BEACON_STORE_NOZZLE_TEMP_OFFSET TEMP=150

	# get and set end temperature offset
	_BEACON_PROBE_NOZZLE_TEMP_OFFSET TEMP=250
	_BEACON_STORE_NOZZLE_TEMP_OFFSET TEMP=250

	# raise z
	G0 Z{z_hop} F{z_speed}

	# move back to safe xy position
	G0 X{safe_home_x} Y{safe_home_y} Z50 F{speed}

	# turn heater off
	SET_HEATER_TEMPERATURE HEATER={"extruder" if default_toolhead == 0 else "extruder1"} TARGET=0

	# echo results
	_BEACON_ECHO_NOZZLE_TEMP_OFFSETS


[gcode_macro _BEACON_PROBE_NOZZLE_TEMP_OFFSET]
gcode:
	# parameters
	{% set temp = params.TEMP|int %}

	# config
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set default_toolhead = printer["gcode_macro RatOS"].default_toolhead|default(0)|int %}

	# ratos variables file
	{% set svv = printer.save_variables.variables %}

	# get reference point coordinates
	{% set idex_zcontrolpoint = svv.idex_zcontrolpoint|default(150)|float %}

	# wait for noozle to reach the probing temperature
	RATOS_ECHO PREFIX="BEACON" MSG="Waiting for nozzle to reach {temp}Â°C..."
	SET_HEATER_TEMPERATURE HEATER={"extruder" if default_toolhead == 0 else "extruder1"} TARGET={temp}
	TEMPERATURE_WAIT SENSOR={"extruder" if default_toolhead == 0 else "extruder1"} MINIMUM={temp} MAXIMUM={temp + 2}

	# wait for temperature to settle down
	RATOS_ECHO PREFIX="BEACON" MSG="Waiting for thermal expansion..."
	G4 P60000

	# probe
	RATOS_ECHO PREFIX="BEACON" MSG="Probing with nozzle temperature {temp}Â°C..."
	PROBE PROBE_METHOD=contact PROBE_SPEED=3 LIFT_SPEED=15 SAMPLES=5 SAMPLE_RETRACT_DIST=3 SAMPLES_TOLERANCE=0.005 SAMPLES_TOLERANCE_RETRIES=10 SAMPLES_RESULT=median
	BEACON_QUERY

	# raise z
	G0 Z5 F{z_speed}


[gcode_macro _BEACON_STORE_NOZZLE_TEMP_OFFSET]
gcode:
	# parameters
	{% set temp = params.TEMP|int %}

	# config
	{% set default_toolhead = printer["gcode_macro RatOS"].default_toolhead|default(0)|int %}

	# ratos variables file
	{% set svv = printer.save_variables.variables %}

	# get last probe result
	{% set last_z = printer.beacon.last_z_result|default(0)|float %}

	# set temperature offset
	{% if temp == 150 %}
		SET_GCODE_VARIABLE MACRO=BEACON_CALIBRATE_NOZZLE_TEMP_OFFSET VARIABLE=reference_z VALUE={last_z}
	{% else %}
		{% set reference_z = printer["gcode_macro BEACON_CALIBRATE_NOZZLE_TEMP_OFFSET"].reference_z|default(0)|float %}
		SAVE_VARIABLE VARIABLE=nozzle_expansion_coefficient_t{default_toolhead} VALUE={(last_z - reference_z)}
	{% endif %}


[gcode_macro _BEACON_ECHO_NOZZLE_TEMP_OFFSETS]
gcode:
	# config
	{% set default_toolhead = printer["gcode_macro RatOS"].default_toolhead|default(0)|int %}

	# ratos variables file
	{% set svv = printer.save_variables.variables %}

	# echo
	{% if default_toolhead == 0 %}
		RATOS_ECHO PREFIX="BEACON" MSG={'"T0 expansion coefficient %.6f"' % svv.nozzle_expansion_coefficient_t0}
	{% else %}
		RATOS_ECHO PREFIX="BEACON" MSG={'"T1 expansion coefficient %.6f"' % svv.nozzle_expansion_coefficient_t1}
	{% endif %}


#####
# BEACON UTILS
#####
[gcode_macro BEACON_MEASURE_GANTRY_TWIST]
gcode:
	# config
	{% set test_margin = 30 %}
	{% set speed = printer["gcode_macro RatOS"].macro_travel_speed|float * 60 %}
	{% set z_speed = printer["gcode_macro RatOS"].macro_z_speed|float * 60 %}
	{% set z_hop_speed = printer.configfile.config.ratos_homing.z_hop_speed|float * 60 %}
	{% set z_hop = printer.configfile.config.ratos_homing.z_hop|float %}
	{% set printable_x_max = printer["gcode_macro RatOS"].printable_x_max|float %}
	{% set printable_y_max = printer["gcode_macro RatOS"].printable_y_max|float %}
	{% set safe_home_x = printer["gcode_macro RatOS"].safe_home_x %}
	{% if safe_home_x is not defined or safe_home_x|lower == 'middle' %}
		{% set safe_home_x = printable_x_max / 2 %}
	{% endif %}
	{% set safe_home_y = printer["gcode_macro RatOS"].safe_home_y %}
	{% if safe_home_y is not defined or safe_home_y|lower == 'middle' %}
		{% set safe_home_y = printable_y_max / 2 %}
	{% endif %}

	MAYBE_HOME

	{% set needs_rehoming = False %}
	{% if printer.z_tilt is defined and not printer.z_tilt.applied %}
		RATOS_ECHO MSG="Adjusting Z tilt..."
		Z_TILT_ADJUST
		RATOS_ECHO MSG="Rehoming Z after Z tilt adjustment..."
		{% set needs_rehoming = True %}
	{% endif %}
	{% if printer.quad_gantry_level is defined and not printer.quad_gantry_level.applied %}
	 	RATOS_ECHO MSG="Running quad gantry leveling..."
		QUAD_GANTRY_LEVEL 
		RATOS_ECHO MSG="Rehoming Z after quad gantry leveling..."
		{% set needs_rehoming = True %}
	{% endif %}

	# Home again as Z will have changed after automatic bed leveling and bed heating.
	{% if needs_rehoming %}
		G0 Z{z_hop} F{z_hop_speed}
		G0 X{safe_home_x} Y{safe_home_y} F{speed}
		{% if printer.configfile.settings.beacon is defined and beacon_contact_z_homing %}
			BEACON_AUTO_CALIBRATE  
			G0 Z{z_hop} F{z_hop_speed}
			G0 X{safe_home_x} Y{safe_home_y} F{speed}
		{% else %}
			G28 Z
		{% endif %}
	{% endif %}

	G0 Z{z_hop} F{z_speed}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}
	BEACON_AUTO_CALIBRATE
	
	M118 Drop
	beacon_offset_compare
	M118 Center
	beacon_offset_compare 

	G0 Z{z_hop} F{z_speed}
	G0 X{test_margin} Y{test_margin} F{speed}
	M118 Front Left
	beacon_offset_compare 

	G0 Z{z_hop} F{z_speed}
	G0 X{safe_home_x} Y{test_margin} F{speed}
	M118 Front Center
	beacon_offset_compare 

	G0 Z{z_hop} F{z_speed}
	G0 X{printable_x_max - test_margin} Y{test_margin} F{speed}
	M118 Front Right
	beacon_offset_compare 

	G0 Z{z_hop} F{z_speed}
	G0 X{printable_x_max - test_margin} Y{printable_y_max - test_margin} F{speed}
	M118 Back Right
	beacon_offset_compare 

	G0 Z{z_hop} F{z_speed}
	G0 X{safe_home_x} Y{printable_y_max - test_margin} F{speed}
	M118 Back Center
	beacon_offset_compare 

	G0 Z{z_hop} F{z_speed}
	G0 X{test_margin} Y{printable_y_max - test_margin} F{speed}
	M118 Back Left
	beacon_offset_compare 

	G0 Z{z_hop} F{z_speed}
	G0 X{safe_home_x} Y{safe_home_y} F{speed}


[gcode_macro POKELOOP]
gcode:
  {% for i in range(100) %}
      beacon_poke speed=3 top=5 bottom=-0.3
  {% endfor %}